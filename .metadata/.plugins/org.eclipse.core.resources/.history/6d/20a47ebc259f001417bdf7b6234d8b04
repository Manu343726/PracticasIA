;Pr√°ctica 6 - Inteligencia Artificial
;Manuel Sanchez, Pablo Mac-Veigh

;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
;; Enumeraciones
;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;

;; Season
;;
;; Rangos estacionales basados en http://www.almanac.com/content/first-day-seasons
;;
;; 0: primavera (90 d√É¬≠as 82 - 172)
;; 1: verano    (90 d√É¬≠as 173 - 263)
;; 2: oto√É¬±o     (90 d√É¬≠as 264 - 354)
;; 3: invierno  (91 d√É¬≠as 355 - 81)

;; hobby / theme
;;
;; 0: Deportes
;; 1: Aventura
;; 2: Cultura
;; 3: Turismo
;; 4: Gastronom√É¬≠a

;; companion 
;;
;; 0: solo
;; 1: familia
;; 2: amigos

;; languages
;;
;; 0: Espa√É¬±ol
;; 1: Ingl√É¬©s
;; 2: Franc√É¬©s
;; 3: Chino
;; 4: Alem√É¬°n
;; 5: Indio
;; 6: Portugu√É¬©s

(defglobal ?*crlf* = "
")

;Definition del template del usuario
(deftemplate user
    (slot season(type number)); √É‚Ä∞poca del a√É¬±o en la que el usuario quiere viajar (ENUMERADO)
    (slot budget(type number)); Presupuesto
    (slot hobby(type number)); Afici√É¬≥n (ENUMERADO). TODO: multislot varias aficiones
    (slot age(type number)); Edad
    (slot companion(type number)); Acompa√É¬±antes (ENUMERADO)
    (slot exotic(type number)); Busca un viaje ex√É¬≥tico? (TRUE:1, FALSE:0)
    (slot languages(type number)); Idioma (ENUMERADO)
)

;Deficici√É¬≥n template viaje
(deftemplate travel
	(slot begins(type number)); D√É¬≠a que empieza el viaje (√ÉÔøΩndice 0-364 representando un d√É¬≠a del a√É¬±o)
    (slot ends(type number)); D√É¬≠a que termina el viaje (√ÉÔøΩndice 0-364 representando un d√É¬≠a del a√É¬±o)
    (slot theme(type number)); Tem√É¬°tica del viaje (Deporte, turismo, aventura, etc) (ENUMERADO)
    ;TODO ofertas especiales
    (slot language(type number)); Idioma del sitio de destino (Ver languages en user) TODO: multislot varios idiomas
    (slot company(type STRING)); Compa√É¬±√É¬≠a
    (slot name(type STRING)); T√É¬≠tulo
    (slot description(type STRING)); Descripci√É¬≥n del viaje     
    ;A√±adir continente
    ;A√±adir 'dureza' del viaje? (en familia o no)
)

;Definicion del template recomendaci√É¬≥n
(deftemplate recommendation
    (slot name(type STRING))
    (slot description(type STRING))
)

;Asertaci√≥n de hechos: Usuario de prueba
(deffacts usr
    (user (season 0) (budget 5000) (hobby 2) (age 26) (companion 0) (exotic 1) (languages 3))
    )

;Asertaci√≥n de hechos: Viajes
(deffacts trvl
    ;(travel (begins) (ends) (theme) (language) (company) (name) (description))
    (travel (begins 20) (ends 30) (theme 2) (language 3) (company "Air China") 
     	(name "Viaje al Tibet") (description "Un viaje al Tibet es todo lo que necesita alguien que busca cultura como tu"))
    )


;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
;; SELECTION MODULE ;This module contains all the functions used by the recommendation module
;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
(defmodule selection)

(deffunction fitsSeason (?beginDate ?endDate ?userSeason)
    "Devuelve verdadero si la temporada que ha elegido el usuario corresponde con la del viaje"
    (return (or 
            	(and (eq ?userSeason 0)(>= ?beginDate 82)(<= ?endDate 172));Primavera del 82 al 172
            	(and (eq ?userSeason 1)(>= ?beginDate 173)(<= ?endDate 263));Verano del 173 al 263
          	    (and (eq ?userSeason 2)(>= ?beginDate 264)(<= ?endDate 354));OtoÒo del 264 al 354
            	(and (eq ?userSeason 1)(>= ?beginDate 355)(<= ?endDate 81));Invierno del 355 al 81
            )
        )
    )


;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
;; RECOMMENDATION MODULE ;This module handles the recomendations
;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
(defmodule travelRecommendation)

(defrule combine-recommendations 
    "Combiena recomendaciones iguales que puedan salir varias veces"
    ?r1 <- (recommendation (name ?n) (description ?d1))
    ?r2 <- (recommendation (name ?n) (description ?d2&:(neq ?d1 ?d2)))
    =>
    (retract ?r2)
    (modify ?r1 (description (str-cat ?d1 ?*crlf* ?d2))))

(defrule recommend
    "Aserta las recomendaciones si estas se ajustan"
    (travel (name ?tn) (begins ?tb) (ends ?te) (theme ?tt) (language ?tl) (company ?tc) (description ?td)) ;Todos los viajes
    (user (season ?us) (budget ?ub) (hobby ?uh) (age ?ua) (companion ?uc) (exotic ?ue) (languages ?ul)) ;Todos los usuarios
    ;Los hechos sobre Travel empiezan las variables con t y los hechos sobre usuarios empiezan con u.
    
    ;llamadas tipo (test (funcion parametros)))
    =>
    (assert (recommendation (name ?tn) (description ?td))) ;Aserta una recomendaciÛn
    )

;Posible regla sobre un viaje ex√≥tico:
;Si el usuario ha seleccionado un viaje ex√≥tico - y no habla el idioma del sitio se considera ex√≥tico?
;Solo es una idea y ejemplo.
(deffunction possibleExoticRule (?travelLanguage ?userExotic ?userLangage)
    (return (and (eq ?userExotic 1) (neq ?travelLangage ?userLangage)))
    )

(reset)
(run)
(facts)
